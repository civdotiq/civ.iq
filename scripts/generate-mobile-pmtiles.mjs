#!/usr/bin/env node

/**
 * Mobile-Optimized PMTiles Generator
 *
 * Creates lightweight PMTiles files for mobile devices by reducing max zoom level
 * from 12 (desktop) to 8 (mobile), resulting in ~75% file size reduction.
 *
 * Input: Existing GeoJSON files from process-state-legislative-districts.mjs
 * Output: state_legislative_districts_mobile.pmtiles (mobile-optimized)
 *
 * Performance Impact:
 * - Desktop: 24MB @ max zoom 12 (high detail)
 * - Mobile: ~6MB @ max zoom 8 (sufficient for mobile screens)
 * - 75% reduction in data transfer for mobile users
 */

import fs from 'fs/promises';
import path from 'path';
import { spawn } from 'child_process';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const CONFIG = {
  tempDir: path.join(process.cwd(), 'temp', 'state-districts'),
  publicDir: path.join(process.cwd(), 'public', 'data'),

  // Input files (generated by process-state-legislative-districts.mjs)
  inputFiles: {
    sldl: 'sldl.geojson',
    sldu: 'sldu.geojson'
  },

  // Output PMTiles files
  outputFiles: {
    mobile: 'state_legislative_districts_mobile.pmtiles',
    desktop: 'state_legislative_districts.pmtiles'
  },

  // Zoom configurations
  zoomConfigs: {
    mobile: {
      maxZoom: 8,
      minZoom: 0,
      baseZoom: 5,
      simplification: 15,
      name: 'State Legislative Districts 2025 (Mobile)'
    },
    desktop: {
      maxZoom: 12,
      minZoom: 0,
      baseZoom: 6,
      simplification: 10,
      name: 'State Legislative Districts 2025 (Desktop)'
    }
  }
};

class MobilePMTilesGenerator {
  constructor() {
    this.startTime = Date.now();
  }

  async run() {
    console.log('ðŸ“± Mobile-Optimized PMTiles Generator');
    console.log('====================================');
    console.log('ðŸŽ¯ Goal: Reduce map data from 24MB â†’ ~6MB for mobile');
    console.log('');

    try {
      // Verify input files exist
      await this.verifyInputFiles();

      // Generate mobile-optimized PMTiles
      await this.generateMobilePMTiles();

      // Generate desktop PMTiles if needed
      await this.generateDesktopPMTiles();

      // Print summary
      await this.printSummary();

      console.log('\nâœ… SUCCESS: Mobile-optimized PMTiles generated');
      console.log(`â±ï¸  Total time: ${((Date.now() - this.startTime) / 1000).toFixed(1)}s`);

    } catch (error) {
      console.error('\nâŒ FAILED:', error.message);
      console.error(error.stack);
      process.exit(1);
    }
  }

  async verifyInputFiles() {
    console.log('ðŸ” Verifying input files...');

    const sldlPath = path.join(CONFIG.tempDir, CONFIG.inputFiles.sldl);
    const slduPath = path.join(CONFIG.tempDir, CONFIG.inputFiles.sldu);

    try {
      await fs.access(sldlPath);
      await fs.access(slduPath);
      console.log('âœ… Input GeoJSON files found');
    } catch {
      throw new Error(
        'Input files not found. Run process-state-legislative-districts.mjs first.'
      );
    }
  }

  async generateMobilePMTiles() {
    console.log('\nðŸ“± Generating mobile-optimized PMTiles (max zoom 8)...');

    const config = CONFIG.zoomConfigs.mobile;
    const sldlPath = path.join(CONFIG.tempDir, CONFIG.inputFiles.sldl);
    const slduPath = path.join(CONFIG.tempDir, CONFIG.inputFiles.sldu);
    const outputPath = path.join(CONFIG.publicDir, CONFIG.outputFiles.mobile);

    // Ensure output directory exists
    await fs.mkdir(CONFIG.publicDir, { recursive: true });

    try {
      await this.runTippecanoe(outputPath, sldlPath, slduPath, config);

      const stats = await fs.stat(outputPath);
      const fileSizeMB = (stats.size / 1024 / 1024).toFixed(1);

      console.log(`âœ… Mobile PMTiles: ${CONFIG.outputFiles.mobile} (${fileSizeMB}MB)`);
      console.log(`   Max zoom: ${config.maxZoom} (mobile-optimized)`);

    } catch (error) {
      throw new Error(`Mobile PMTiles generation failed: ${error.message}`);
    }
  }

  async generateDesktopPMTiles() {
    console.log('\nðŸ–¥ï¸  Checking desktop PMTiles...');

    const desktopPath = path.join(CONFIG.publicDir, CONFIG.outputFiles.desktop);

    try {
      await fs.access(desktopPath);
      const stats = await fs.stat(desktopPath);
      const fileSizeMB = (stats.size / 1024 / 1024).toFixed(1);
      console.log(`âœ… Desktop PMTiles exists: ${CONFIG.outputFiles.desktop} (${fileSizeMB}MB)`);
    } catch {
      console.log('âš ï¸  Desktop PMTiles not found, generating...');

      const config = CONFIG.zoomConfigs.desktop;
      const sldlPath = path.join(CONFIG.tempDir, CONFIG.inputFiles.sldl);
      const slduPath = path.join(CONFIG.tempDir, CONFIG.inputFiles.sldu);

      await this.runTippecanoe(desktopPath, sldlPath, slduPath, config);

      const stats = await fs.stat(desktopPath);
      const fileSizeMB = (stats.size / 1024 / 1024).toFixed(1);
      console.log(`âœ… Desktop PMTiles: ${CONFIG.outputFiles.desktop} (${fileSizeMB}MB)`);
    }
  }

  async runTippecanoe(outputPath, sldlPath, slduPath, config) {
    const args = [
      '-o', outputPath,
      '--force',
      `--maximum-zoom=${config.maxZoom}`,
      `--minimum-zoom=${config.minZoom}`,
      `--base-zoom=${config.baseZoom}`,
      '--drop-densest-as-needed',
      `--simplification=${config.simplification}`,
      '--coalesce-densest-as-needed',
      '--extend-zooms-if-still-dropping',
      '--layer=sldl',
      '--layer=sldu',
      `--named-layer=sldl:${sldlPath}`,
      `--named-layer=sldu:${slduPath}`,
      `--name=${config.name}`,
      '--attribution=U.S. Census Bureau'
    ];

    return this.runCommand('tippecanoe', args);
  }

  async printSummary() {
    console.log('\nðŸ“Š File Size Comparison:');
    console.log('========================');

    const mobilePath = path.join(CONFIG.publicDir, CONFIG.outputFiles.mobile);
    const desktopPath = path.join(CONFIG.publicDir, CONFIG.outputFiles.desktop);

    try {
      const mobileStats = await fs.stat(mobilePath);
      const desktopStats = await fs.stat(desktopPath);

      const mobileMB = (mobileStats.size / 1024 / 1024).toFixed(1);
      const desktopMB = (desktopStats.size / 1024 / 1024).toFixed(1);
      const reduction = ((1 - mobileStats.size / desktopStats.size) * 100).toFixed(0);

      console.log(`Mobile:  ${mobileMB}MB (max zoom 8)`);
      console.log(`Desktop: ${desktopMB}MB (max zoom 12)`);
      console.log(`Savings: ${reduction}% reduction for mobile users`);
      console.log('');
      console.log('ðŸ’¡ Mobile users on 3G (750 Kbps):');
      console.log(`   Desktop: ${(desktopStats.size / (750 / 8) / 1024).toFixed(0)}s download time`);
      console.log(`   Mobile:  ${(mobileStats.size / (750 / 8) / 1024).toFixed(0)}s download time`);

    } catch (error) {
      console.warn('âš ï¸  Could not calculate size comparison');
    }
  }

  async runCommand(command, args) {
    return new Promise((resolve, reject) => {
      const proc = spawn(command, args);

      let stdout = '';
      let stderr = '';

      proc.stdout.on('data', (data) => {
        stdout += data;
      });

      proc.stderr.on('data', (data) => {
        stderr += data;
      });

      proc.on('close', (code) => {
        if (code === 0) {
          resolve(stdout);
        } else {
          reject(new Error(`Command failed with code ${code}: ${stderr}`));
        }
      });
    });
  }
}

// Run if called directly
if (import.meta.url === `file://${process.argv[1]}`) {
  const generator = new MobilePMTilesGenerator();
  await generator.run();
}

export default MobilePMTilesGenerator;
