<?xml version="1.0" encoding="UTF-8"?>
<codebase>
<!-- Generated on 2025-08-17T22:25:34.230Z -->
<!-- Project: civic-intel-hub -->
<file path="representatives.ts">
/**
 * Copyright (c) 2019-2025 Mark Sandford
 * Licensed under the MIT License. See LICENSE and NOTICE files.
 */

import { cache } from &apos;@/lib/cache&apos;;
import { RepresentativeProfile, BatchApiResponse } from &apos;@/types/representative&apos;;

// Base API configuration - FIXED to work with Next.js API routes
const getApiBaseUrl = () =&gt; {
  // For client-side requests
  if (typeof window !== &apos;undefined&apos;) {
    // Use relative URLs for same-origin requests (your API routes)
    // This ensures requests go to /api/... on the same domain
    return &apos;&apos;;
  }
  // For server-side requests (if needed)
  return process.env.NEXT_PUBLIC_API_URL || &apos;&apos;;
};

const DEFAULT_TIMEOUT = 30000; // 30 seconds for batch requests

// Error types for better error handling
export class RepresentativeApiError extends Error {
  constructor(
    message: string,
    public statusCode: number,
    public endpoint?: string,
    public originalError?: Error
  ) {
    super(message);
    this.name = &apos;RepresentativeApiError&apos;;
  }
}

// Next.js 15 optimized fetch wrapper with built-in caching and deduplication
async function apiRequest&lt;T&gt;(
  endpoint: string,
  options: RequestInit &amp; {
    cacheTime?: number;
    tags?: string[];
    revalidate?: number | false;
  } = {}
): Promise&lt;T&gt; {
  const { cacheTime = 300, tags = [], revalidate, ...fetchOptions } = options;

  // FIXED: Ensure endpoint starts with / for relative URLs
  const normalizedEndpoint = endpoint.startsWith(&apos;/&apos;) ? endpoint : `/${endpoint}`;
  const baseUrl = getApiBaseUrl();
  const url = `${baseUrl}${normalizedEndpoint}`;

  console.log(`[CIV.IQ-DEBUG] API Request: ${fetchOptions.method || &apos;GET&apos;} ${url}`);
  console.log(`[CIV.IQ-DEBUG] Base URL: &quot;${baseUrl}&quot;, Endpoint: &quot;${normalizedEndpoint}&quot;`);

  try {
    // Create AbortController for timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() =&gt; controller.abort(), DEFAULT_TIMEOUT);

    const response = await fetch(url, {
      ...fetchOptions,
      headers: {
        &apos;Content-Type&apos;: &apos;application/json&apos;,
        ...fetchOptions.headers,
      },
      signal: controller.signal,
      // Next.js 15 caching with automatic deduplication
      ...(revalidate !== undefined
        ? {
            next: {
              revalidate: revalidate !== false ? revalidate : cacheTime,
              tags: [...tags, `api-${endpoint.split(&apos;/&apos;).join(&apos;-&apos;)}`],
            },
          }
        : {}),
    });

    clearTimeout(timeoutId);

    console.log(`[CIV.IQ-DEBUG] API Response: ${response.status} ${response.statusText}`);

    if (!response.ok) {
      const errorText = await response.text().catch(() =&gt; &apos;No error details&apos;);
      console.error(`[CIV.IQ-DEBUG] API Error Response:`, errorText);

      throw new RepresentativeApiError(
        `API request failed: ${response.status} ${response.statusText}`,
        response.status,
        endpoint,
        new Error(errorText)
      );
    }

    const data = await response.json();
    console.log(`[CIV.IQ-DEBUG] API Success Response:`, {
      endpoint,
      hasData: !!data,
      dataKeys: data ? Object.keys(data).slice(0, 5) : [],
    });

    return data;
  } catch (error) {
    console.error(`[CIV.IQ-DEBUG] API Request Error:`, {
      endpoint,
      error: error instanceof Error ? error.message : String(error),
      errorType: error instanceof Error ? error.constructor.name : typeof error,
    });

    if (error instanceof RepresentativeApiError) {
      throw error;
    }

    // Handle abort/timeout errors
    if (error instanceof Error &amp;&amp; error.name === &apos;AbortError&apos;) {
      throw new RepresentativeApiError(&apos;Request timeout - please try again&apos;, 408, endpoint, error);
    }

    throw new RepresentativeApiError(
      `Network error: ${error instanceof Error ? error.message : &apos;Unknown error&apos;}`,
      500,
      endpoint,
      error instanceof Error ? error : new Error(String(error))
    );
  }
}

// Representative API client
export const representativeApi = {
  /**
   * Get representative profile using batch API for optimal performance
   */
  async getProfileBatch(
    bioguideId: string,
    options: {
      includeVotes?: boolean;
      includeBills?: boolean;
      includeFinance?: boolean;
      includeNews?: boolean;
      includePartyAlignment?: boolean;
      includeCommittees?: boolean;
      includeLeadership?: boolean;
      includeDistrict?: boolean;
    } = {}
  ): Promise&lt;BatchApiResponse&gt; {
    // Build endpoint list based on options
    const endpoints: string[] = [&apos;profile&apos;]; // Always include basic profile

    if (options.includeVotes) endpoints.push(&apos;votes&apos;);
    if (options.includeBills) endpoints.push(&apos;bills&apos;);
    if (options.includeFinance) endpoints.push(&apos;finance&apos;);
    if (options.includeNews) endpoints.push(&apos;news&apos;);
    if (options.includePartyAlignment) endpoints.push(&apos;party-alignment&apos;);
    if (options.includeCommittees) endpoints.push(&apos;committees&apos;);
    if (options.includeLeadership) endpoints.push(&apos;leadership&apos;);
    if (options.includeDistrict) endpoints.push(&apos;district&apos;);

    console.log(`[CIV.IQ-DEBUG] Batch request for ${bioguideId} with endpoints:`, endpoints);

    try {
      const response = await apiRequest&lt;BatchApiResponse&gt;(
        `/api/representative/${bioguideId}/batch`,
        {
          method: &apos;POST&apos;,
          body: JSON.stringify({ endpoints }),
        }
      );

      console.log(`[CIV.IQ-DEBUG] Batch response processed successfully:`, {
        bioguideId,
        endpointsRequested: endpoints.length,
        successfulEndpoints: Object.keys(response.data || {}).length,
        hasErrors: response.errors &amp;&amp; Object.keys(response.errors).length &gt; 0,
        executionTime: response.executionTime,
      });

      return response;
    } catch (error) {
      console.error(`[CIV.IQ-DEBUG] Batch API failed, falling back to individual calls`, error);
      // Return empty batch response on error
      return {
        success: false,
        data: {},
        errors: {
          batch: error instanceof Error ? error.message : &apos;Batch API failed&apos;,
        },
        metadata: {
          timestamp: new Date().toISOString(),
          requestedEndpoints: endpoints,
          successfulEndpoints: [],
          failedEndpoints: endpoints,
          totalTime: 0,
        },
        executionTime: 0,
      };
    }
  },

  /**
   * Get individual representative profile (fallback method)
   */
  async getProfile(bioguideId: string): Promise&lt;RepresentativeProfile&gt; {
    return apiRequest&lt;RepresentativeProfile&gt;(`/api/representative/${bioguideId}`, {
      cacheTime: 600, // 10 minutes - profile data changes infrequently
      tags: [`representative-${bioguideId}`, &apos;representative-profile&apos;],
    });
  },

  /**
   * Get representative votes - client-side with shorter cache for real-time updates
   */
  async getVotes(bioguideId: string): Promise&lt;any&gt; {
    return apiRequest(`/api/representative/${bioguideId}/votes`, {
      cacheTime: 300, // 5 minutes - voting data updates frequently
      tags: [`representative-${bioguideId}`, &apos;representative-votes&apos;],
    });
  },

  /**
   * Get representative bills
   */
  async getBills(bioguideId: string): Promise&lt;any&gt; {
    return apiRequest(`/api/representative/${bioguideId}/bills`, {
      cacheTime: 600, // 10 minutes - bill data changes moderately
      tags: [`representative-${bioguideId}`, &apos;representative-bills&apos;],
    });
  },

  /**
   * Get representative finance data
   */
  async getFinance(bioguideId: string): Promise&lt;any&gt; {
    return apiRequest(`/api/representative/${bioguideId}/finance`, {
      cacheTime: 1800, // 30 minutes - finance data changes less frequently
      tags: [`representative-${bioguideId}`, &apos;representative-finance&apos;],
    });
  },

  /**
   * Get representative news - short cache for real-time updates
   */
  async getNews(bioguideId: string): Promise&lt;any&gt; {
    return apiRequest(`/api/representative/${bioguideId}/news`, {
      cacheTime: 180, // 3 minutes - news updates frequently
      tags: [`representative-${bioguideId}`, &apos;representative-news&apos;],
    });
  },

  /**
   * Get party alignment analysis
   */
  async getPartyAlignment(bioguideId: string): Promise&lt;any&gt; {
    return apiRequest(`/api/representative/${bioguideId}/party-alignment`, {
      cacheTime: 1800, // 30 minutes - alignment data changes slowly
      tags: [`representative-${bioguideId}`, &apos;representative-party-alignment&apos;],
    });
  },

  /**
   * Get committee assignments
   */
  async getCommittees(bioguideId: string): Promise&lt;any&gt; {
    return apiRequest(`/api/representative/${bioguideId}/committees`, {
      cacheTime: 3600, // 1 hour - committee assignments change infrequently
      tags: [`representative-${bioguideId}`, &apos;representative-committees&apos;],
    });
  },

  /**
   * Get leadership positions
   */
  async getLeadership(bioguideId: string): Promise&lt;any&gt; {
    return apiRequest(`/api/representative/${bioguideId}/leadership`, {
      cacheTime: 3600, // 1 hour - leadership positions change infrequently
      tags: [`representative-${bioguideId}`, &apos;representative-leadership&apos;],
    });
  },

  /**
   * Get district information
   */
  async getDistrict(bioguideId: string): Promise&lt;any&gt; {
    return apiRequest(`/api/representative/${bioguideId}/district`, {
      cacheTime: 3600, // 1 hour - district info changes rarely
      tags: [`representative-${bioguideId}`, &apos;representative-district&apos;],
    });
  },

  /**
   * Search representatives - with deduplication for common searches
   */
  async search(params: {
    zip?: string;
    state?: string;
    district?: string;
    party?: string;
    chamber?: string;
    query?: string;
  }): Promise&lt;RepresentativeProfile[]&gt; {
    const searchParams = new URLSearchParams();

    Object.entries(params).forEach(([key, value]) =&gt; {
      if (value) searchParams.append(key, value);
    });

    const queryString = searchParams.toString();
    return apiRequest&lt;RepresentativeProfile[]&gt;(
      `/api/representatives${queryString ? `?${queryString}` : &apos;&apos;}`,
      {
        cacheTime: 300, // 5 minutes for search results
        tags: [&apos;representatives-search&apos;, `search-${queryString}`],
      }
    );
  },

  /**
   * Get representatives by ZIP code - highly cached due to frequent access
   */
  async getByZip(zipCode: string): Promise&lt;RepresentativeProfile[]&gt; {
    return apiRequest&lt;RepresentativeProfile[]&gt;(`/api/representatives?zip=${zipCode}`, {
      cacheTime: 600, // 10 minutes - ZIP lookups are expensive
      tags: [&apos;representatives-zip&apos;, `zip-${zipCode}`],
    });
  },
};

// RepresentativeApiError is already exported above with the class declaration
export type { BatchApiResponse };

</file>
<file path="wikidata.ts">
/**
 * Copyright (c) 2019-2025 Mark Sandford
 * Licensed under the MIT License. See LICENSE and NOTICE files.
 */

/**
 * Wikidata integration for representative age data
 * Maps bioguide IDs to Wikidata IDs and fetches birth dates via SPARQL
 * ONLY used for age calculation - follows CLAUDE.MD rules
 */

// Map bioguide IDs to Wikidata IDs (official government data cross-reference)
const BIOGUIDE_TO_WIKIDATA: Record&lt;string, string&gt; = {
  T000488: &apos;Q115604581&apos;, // Shri Thanedar
  P000197: &apos;Q170581&apos;, // Nancy Pelosi
  A000374: &apos;Q5584301&apos;, // Ralph Abraham
  B001298: &apos;Q28038204&apos;, // Don Bacon
  B001291: &apos;Q22966652&apos;, // Brian Babin
  // Add more mappings as needed
};

interface WikidataResponse {
  results: {
    bindings: Array&lt;{
      birthDate: {
        value: string;
        type: string;
      };
    }&gt;;
  };
}

/**
 * Fetch birth date from Wikidata SPARQL endpoint
 * @param bioguideId - Official bioguide ID from Congress
 * @returns Age in years or null if not found
 */
export async function getAgeFromWikidata(bioguideId: string): Promise&lt;number | null&gt; {
  try {
    const wikidataId = BIOGUIDE_TO_WIKIDATA[bioguideId];
    if (!wikidataId) {
      return null;
    }

    // SPARQL query to get birth date
    const query = `
      SELECT ?birthDate WHERE {
        wd:${wikidataId} wdt:P569 ?birthDate.
      }
    `;

    const encodedQuery = encodeURIComponent(query);
    const sparqlUrl = `https://query.wikidata.org/sparql?query=${encodedQuery}&amp;format=json`;

    const response = await fetch(sparqlUrl, {
      headers: {
        Accept: &apos;application/json&apos;,
        &apos;User-Agent&apos;: &apos;CivicIntelHub/1.0 (https://civ.iq) Government Data Portal&apos;,
      },
    });

    if (!response.ok) {
      return null;
    }

    const data: WikidataResponse = await response.json();

    if (!data.results.bindings.length || !data.results.bindings[0]) {
      return null;
    }

    const birthDateStr = data.results.bindings[0].birthDate.value;
    const birthDate = new Date(birthDateStr);
    const today = new Date();

    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();

    if (monthDiff &lt; 0 || (monthDiff === 0 &amp;&amp; today.getDate() &lt; birthDate.getDate())) {
      age--;
    }

    return age;
  } catch {
    return null;
  }
}

/**
 * Check if bioguide ID has Wikidata mapping
 * @param bioguideId - Official bioguide ID
 * @returns boolean indicating if mapping exists
 */
export function hasWikidataMapping(bioguideId: string): boolean {
  return bioguideId in BIOGUIDE_TO_WIKIDATA;
}

/**
 * Get Wikidata ID for bioguide ID
 * @param bioguideId - Official bioguide ID
 * @returns Wikidata ID or null
 */
export function getWikidataId(bioguideId: string): string | null {
  return BIOGUIDE_TO_WIKIDATA[bioguideId] || null;
}

</file>
</codebase>