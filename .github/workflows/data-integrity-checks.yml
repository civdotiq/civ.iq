name: Data Integrity Validation

# CRITICAL: This workflow ensures no civic data ships with coordinate system bugs
# or other data integrity failures that could mislead citizens about their districts.

on:
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'scripts/**'
      - 'public/data/**'
      - 'package.json'
      - 'package-lock.json'
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'scripts/**'
      - 'public/data/**'

jobs:
  data-integrity-validation:
    name: ğŸ›¡ï¸ Validate Civic Data Integrity
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ”§ Install Dependencies
        run: |
          npm ci --prefer-offline --no-audit
          echo "âœ… Dependencies installed"

      - name: ğŸ§­ TypeScript Type Checking
        run: |
          npm run type-check
          echo "âœ… TypeScript types validated"

      - name: ğŸ¯ ESLint Code Quality
        run: |
          npm run lint
          echo "âœ… Code quality validated"

      - name: ğŸ§ª Unit Tests - Geospatial Utilities
        run: |
          echo "ğŸ” Running critical geospatial utility tests..."
          npm test src/tests/district-data.test.ts
          echo "âœ… Geospatial utilities validated"

      - name: ğŸŒ API Integration Tests
        run: |
          echo "ğŸš€ Starting development server for API tests..."
          npm run build
          npm run start &
          SERVER_PID=$!
          
          echo "â³ Waiting for server to start..."
          sleep 10
          
          echo "ğŸ§ª Running API integration tests..."
          npm test src/tests/district-api.test.ts || {
            echo "âŒ API tests failed - checking server status"
            curl -f http://localhost:3000/api/district-boundaries/CA-12 || true
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          }
          
          echo "âœ… API integration tests passed"
          kill $SERVER_PID 2>/dev/null || true

      - name: ğŸ“Š District Data Validation
        run: |
          echo "ğŸ›ï¸ Validating congressional district data integrity..."
          if [ -f "scripts/validate-data.ts" ]; then
            npm run validate-districts | tee validation-report.log
            
            # Check for critical failures
            if grep -q "CRITICAL ERRORS FOUND" validation-report.log; then
              echo "âŒ CRITICAL: District data has coordinate system errors!"
              echo "This could mislead citizens about their representatives."
              grep -A 20 "CRITICAL ERRORS FOUND" validation-report.log
              exit 1
            fi
            
            # Check success rate
            SUCCESS_RATE=$(grep -o "Success Rate: [0-9.]*%" validation-report.log | grep -o "[0-9.]*" || echo "0")
            if (( $(echo "$SUCCESS_RATE < 95.0" | bc -l) )); then
              echo "âŒ District validation success rate too low: ${SUCCESS_RATE}%"
              echo "Minimum required: 95%"
              exit 1
            fi
            
            echo "âœ… District data validation passed (${SUCCESS_RATE}% success rate)"
          else
            echo "âš ï¸ District validation script not found - skipping"
          fi

      - name: ğŸ” Golden Record Validation
        run: |
          echo "ğŸ¯ Validating golden record districts..."
          node -e "
            const fs = require('fs');
            
            // Check CA-12 San Francisco
            const ca12Path = 'public/data/districts/full/0612.json';
            if (fs.existsSync(ca12Path)) {
              const ca12 = JSON.parse(fs.readFileSync(ca12Path, 'utf-8'));
              const firstCoord = ca12.geometry.coordinates[0][0];
              const [lon, lat] = firstCoord;
              
              console.log(\`CA-12 coordinates: [\${lon.toFixed(4)}, \${lat.toFixed(4)}]\`);
              
              if (lat < 0) {
                console.error('âŒ CRITICAL: CA-12 has negative latitude - wrong hemisphere!');
                process.exit(1);
              }
              
              if (Math.abs(lat - 37.78) > 1.0) {
                console.error(\`âŒ CRITICAL: CA-12 latitude \${lat} too far from SF expected ~37.78\`);
                process.exit(1);
              }
              
              console.log('âœ… CA-12 San Francisco coordinates validated');
            } else {
              console.log('âš ï¸ CA-12 district file not found - may need regeneration');
            }
            
            // Check NY-14 Bronx/Queens
            const ny14Path = 'public/data/districts/full/3614.json';
            if (fs.existsSync(ny14Path)) {
              const ny14 = JSON.parse(fs.readFileSync(ny14Path, 'utf-8'));
              const firstCoord = ny14.geometry.coordinates[0][0];
              const [lon, lat] = firstCoord;
              
              console.log(\`NY-14 coordinates: [\${lon.toFixed(4)}, \${lat.toFixed(4)}]\`);
              
              if (lat < 0) {
                console.error('âŒ CRITICAL: NY-14 has negative latitude - wrong hemisphere!');
                process.exit(1);
              }
              
              if (Math.abs(lat - 40.85) > 1.0) {
                console.error(\`âŒ CRITICAL: NY-14 latitude \${lat} too far from NYC expected ~40.85\`);
                process.exit(1);
              }
              
              console.log('âœ… NY-14 Bronx/Queens coordinates validated');
            } else {
              console.log('âš ï¸ NY-14 district file not found - may need regeneration');
            }
          "

      - name: ğŸ“ˆ Test Coverage Summary
        run: |
          echo "ğŸ“Š Data Integrity Test Summary:"
          echo "âœ… Geospatial utilities: Unit tested"
          echo "âœ… API endpoints: Integration tested"
          echo "âœ… District data: Validation tested"
          echo "âœ… Golden records: Coordinate tested"
          echo ""
          echo "ğŸ›¡ï¸ Quality gates ensure:"
          echo "   â€¢ No hemisphere coordinate bugs"
          echo "   â€¢ No invalid district boundaries"
          echo "   â€¢ API returns correct civic data"
          echo "   â€¢ Citizens get accurate information"

  security-scan:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ”’ NPM Security Audit
        run: |
          echo "ğŸ” Running security audit..."
          npm audit --audit-level moderate
          echo "âœ… Security audit passed"

      - name: ğŸ“‹ Dependency Check
        run: |
          echo "ğŸ“¦ Checking for critical dependency updates..."
          npm outdated --depth=0 || true
          echo "âœ… Dependency check complete"

  validate-build:
    name: ğŸ—ï¸ Production Build Test
    runs-on: ubuntu-latest
    needs: [data-integrity-validation]

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ”§ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ—ï¸ Production Build
        run: |
          echo "ğŸ”¨ Building for production..."
          npm run build
          echo "âœ… Production build successful"

      - name: ğŸ§ª Build Validation
        run: |
          echo "ğŸ” Validating build artifacts..."
          
          # Check if critical files exist
          if [ ! -f ".next/BUILD_ID" ]; then
            echo "âŒ Build ID missing"
            exit 1
          fi
          
          # Check if static assets exist
          if [ ! -d ".next/static" ]; then
            echo "âŒ Static assets missing"
            exit 1
          fi
          
          echo "âœ… Build artifacts validated"

# Workflow Status Badge
# Add this to your README.md:
# [![Data Integrity](https://github.com/YOUR_USERNAME/civic-intel-hub/workflows/Data%20Integrity%20Validation/badge.svg)](https://github.com/YOUR_USERNAME/civic-intel-hub/actions/workflows/data-integrity-checks.yml)